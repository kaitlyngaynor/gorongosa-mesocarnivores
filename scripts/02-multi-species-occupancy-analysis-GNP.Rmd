---
title: "GNP Models"
author: "Katie Grabowski"
date: "7/28/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---
Here we go!
#install packages 
```{r}
library("unmarked") #install.packages("unmarked")
library(camtrapR) #install.packages("camtrapR")
library(tidyverse)
library(dplyr)
```

#use unmarkedFrameOccuMulti to create the data object
```{r}
# load in detection histories
genet_dh <-read_csv("data/gorongosa-cameras/genet.csv", col_names = FALSE) %>% as.matrix()

civet_dh <-read_csv("data/gorongosa-cameras/civet.csv", col_names = FALSE) %>% as.matrix()

honeybadger_dh <-read_csv("data/gorongosa-cameras/honey_badger.csv", col_names = FALSE) %>% as.matrix()

marshmongoose_dh <-read_csv("data/gorongosa-cameras/marsh_mongoose.csv", col_names = FALSE) %>% as.matrix()

#I know I could have done this in the function, but separating it made more sense for me
y <- list(genet_dh, civet_dh, honeybadger_dh, marshmongoose_dh)
names(y) <- c('genet','civet','honey badger', 'marsh mongoose')

#load occupancy covariates
#leaving the column names in for now
occ_covs <- read_csv("data/gorongosa-cameras/GNP covariates.csv", col_names = TRUE) %>% as.data.frame()

#scaling all the non-binary covariates to address the NaN warnings
occ_covs$urema_dist = scale(occ_covs$urema_dist)
occ_covs$tree_hansen = scale(occ_covs$tree_hansen)
occ_covs$termite.large.count.100m = scale(occ_covs$termite.large.count.100m)
occ_covs$lion_latedry = scale(occ_covs$lion_latedry)
occ_covs$cover.ground = scale(occ_covs$cover.ground)

data <- unmarkedFrameOccuMulti(y = y, siteCovs = occ_covs)

#look at data
summary(data)
plot(data)

# Look at f parameter design matrix
data@fDesign
data@ylist
```
my f equation order: 
f1: genet
f2: civet
f3: honey badger
f4: marsh mongoose
f5: genet: civet
f6: genet: honey badger
f7: genet: marsh mongoose
f8: civet: honey badger
f9: civet: marsh mongoose
f10: honey badger: marsh mongoose

#run occuMulti
```{r}
# Formulas for state and detection processes
# dummy model

# Length should match number/order of columns in fDesign
occFormulas <- c('~urema_dist','~tree_hansen','~termite.large.count.100m','~lion_latedry','~1','~1','~1','~1','~1','~1', '0', '0', '0', '0', '0')

#Length should match number/order of species in data@ylist (genet, civet, honey badger, marsh mongoose)
detFormulas <- c('~detect.obscured+cover.ground', '~detect.obscured+cover.ground', '~detect.obscured+cover.ground', '~detect.obscured+cover.ground')

fit <- occuMulti(detFormulas, stateformulas = occFormulas, data)
```

# explore model output
```{r}
#Look at output from dummy model
fit

#gives a list with one element for the state model
occ <- summary(fit[1]) 

write_csv(occ, "data/gorongosa-cameras/fit_occ.csv", col_names = T)

#plot(fit)

# occupancy only
fit@estimates[1]

# detection only
fit@estimates[2]

#leaving these in because they're potentially helpful to remember as functions that exist
unclass(fit) 
attr(fit, "estimates") 
as.data.frame(coef(fit))

#predict method
lapply(predict(fit,'state'),head)
lapply(predict(fit,'det'),head)

#marginal occupancy
head(predict(fit,'state',species='civet'))
head(predict(fit,'state',species='genet')) # why is this all 1 / 0 / 0?
head(predict(fit,'state',species='honey badger'))
head(predict(fit,'state',species='marsh mongoose'))
head(predict(fit,'det',species='civet')) # why are all of these the same?

#used to compare outcomes 
fl <- fitList(fit,fit2, fit3)
coef(fl)
```

#starting to think about actual models with ecological background [type 1, no species interactions]
```{r}
#null model for both occ and det
fit0 <- occuMulti(detformulas = c('~1', '~1', '~1', '~1'), stateformulas = c('~1', '~1', '~1', '~1','0','0','0','0','0','0','0','0','0','0','0'), data)

fit0

#null model for only occ
fit00 <- occuMulti(detformulas = c('~detect.obscured+cover.ground', '~detect.obscured+cover.ground', '~detect.obscured+cover.ground', '~detect.obscured+cover.ground'), stateformulas = c('~1', '~1', '~1', '~1','0','0','0','0','0','0','0','0','0','0','0'), data)

fit00

# Length should match number/order of columns in fDesign
occFormulas1 <- c('~urema_dist','~urema_dist','~termite.large.count.100m','~urema_dist','0','0','0','0','0','0', '0', '0', '0', '0', '0')

#Length should match number/order of species in data@ylist (genet, civet, honey badger, marsh mongoose)
detFormulas <- c('~detect.obscured+cover.ground', '~detect.obscured+cover.ground', '~detect.obscured+cover.ground', '~detect.obscured+cover.ground')

fit1 <- occuMulti(detFormulas, stateformulas = occFormulas1, data)

fit1

occFormulas2 <- c('~urema_dist+tree_hansen','~urema_dist + tree_hansen','~termite.large.count.100m + tree_hansen','~urema_dist + tree_hansen','0','0','0','0','0','0', '0', '0', '0', '0', '0')

fit2 <- occuMulti(detFormulas, stateformulas = occFormulas2, data)

fit2

#trying a model based on results from single species explorations
occFormulas3 <- c('~urema_dist','~urema_dist + termite.large.count.100m','~urema_dist + tree_hansen','~termite.large.count.100m','0','0','0','0','0','0', '0', '0', '0', '0', '0')

fit3 <- occuMulti(detFormulas, stateformulas = occFormulas3, data)

fit3
```

#starting to think about actual models with ecological background [type 2, no interaction covariates]
```{r}
#null model
fit01 <- occuMulti(detformulas = c('~1', '~1', '~1', '~1'), stateformulas = c('~1', '~1', '~1', '~1','~1','~1','~1','~1','~1','~1','0','0','0','0','0'), data)

fit01

#null model
fit001 <- occuMulti(detformulas = c('~detect.obscured+cover.ground', '~detect.obscured+cover.ground', '~detect.obscured+cover.ground', '~detect.obscured+cover.ground'), stateformulas = c('~1', '~1', '~1', '~1','~1','~1','~1','~1','~1','~1','0','0','0','0','0'), data)

fit001

# Length should match number/order of columns in fDesign
#single 'best' occ covariate from reading
occFormulas11 <- c('~urema_dist','~urema_dist','~termite.large.count.100m','~urema_dist','~1','~1','~1','~1','~1','~1', '0', '0', '0', '0', '0')

#Length should match number/order of species in data@ylist (genet, civet, honey badger, marsh mongoose)
detFormulas <- c('~detect.obscured+cover.ground', '~detect.obscured+cover.ground', '~detect.obscured+cover.ground', '~detect.obscured+cover.ground')

fit11 <- occuMulti(detFormulas, stateformulas = occFormulas11, data)

#why does this not produce anything except estimates?
fit11

#top two occ covariates from reading
occFormulas12 <- c('~urema_dist+tree_hansen','~urema_dist + tree_hansen','~termite.large.count.100m + tree_hansen','~urema_dist + tree_hansen','~1','~1','~1','~1','~1','~1', '0', '0', '0', '0', '0')

fit12 <- occuMulti(detFormulas, stateformulas = occFormulas12, data)

fit12

#best occ covariates from single species exploration
occFormulas13 <- c('~urema_dist','~urema_dist + termite.large.count.100m','~urema_dist + tree_hansen','~termite.large.count.100m','~1','~1','~1','~1','~1','~1', '0', '0', '0', '0', '0')

fit13 <- occuMulti(detFormulas, stateformulas = occFormulas13, data)

fit13

```

#starting to think about actual models with ecological background [type 3, includes interaction covariates] 

```{r}
# Length should match number/order of columns in fDesign
occFormulas21 <- c('~urema_dist','~urema_dist','~termite.large.count.100m','~urema_dist','~lion_latedry','~lion_latedry','~lion_latedry','~lion_latedry','~lion_latedry','~lion_latedry', '0', '0', '0', '0', '0')

fit21 <- occuMulti(detFormulas, stateformulas = occFormulas21, data)

fit21

#top two occ covariates from reading
occFormulas22 <- c('~urema_dist+tree_hansen','~urema_dist + tree_hansen','~termite.large.count.100m + tree_hansen','~urema_dist + tree_hansen','~lion_latedry','~lion_latedry','~lion_latedry','~lion_latedry','~lion_latedry','~lion_latedry', '0', '0', '0', '0', '0')

fit22 <- occuMulti(detFormulas, stateformulas = occFormulas22, data)

fit22

#best occ covariates from single species exploration
occFormulas23 <- c('~urema_dist','~urema_dist + termite.large.count.100m','~urema_dist + tree_hansen','~termite.large.count.100m','~lion_latedry','~lion_latedry','~lion_latedry','~lion_latedry','~lion_latedry','~lion_latedry', '0', '0', '0', '0', '0')

fit23 <- occuMulti(detFormulas, stateformulas = occFormulas23, data)

fit23
```

#model comparisons
```{r}
#List of fitted models
fl <- fitList(fit0, fit00, fit1, fit2, fit3, fit01, fit001, fit11, fit12, fit13, fit21, fit22, fit23)
coef(fl)

#Model selection
modsel <- modSel(fl)
modSel(fl)
summary(modsel)

ms <- modSel(fl, nullmod="fit0")
ms
 
coef(ms)                            # Estimates only
SE(ms)                              # Standard errors only
(toExport <- as(ms, "data.frame"))  # Everything as a data frame

```

```{r}
#conditional occupancy
head(predict(fit3,'state',species='civet',cond='genet')) #civet | genet present
head(predict(fit,'state',species='tiger',cond='bear')) #tiger | bear present
head(predict(fit,'state',species='tiger',cond='-bear')) #bear absent
head(predict(fit,'state',species='tiger',cond=c('coyote','-bear')))

```

