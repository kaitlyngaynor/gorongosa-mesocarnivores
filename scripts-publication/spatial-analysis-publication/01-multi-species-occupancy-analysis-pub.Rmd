---
title: "GNP Models 2023"
author: "Katie Grabowski"
date: "8/1/2023"
output: html_document
editor_options: 
  chunk_output_type: console
---

#install packages 
```{r}
library("unmarked")  #install.packages("unmarked") 
library(camtrapR) #install.packages("camtrapR")
library(tidyverse)
library(dplyr)
library(patchwork) #install.packages("patchwork")
library(ggpubr)  #install.packages("ggpubr")
```

#use unmarkedFrameOccuMulti to create the data object
```{r}
# load in detection histories
genet_dh <-read_csv("data-publication/genet.csv", col_names = FALSE) %>% as.matrix()

civet_dh <-read_csv("data-publication/civet.csv", col_names = FALSE) %>% as.matrix()

honeybadger_dh <-read_csv("data-publication/honey_badger.csv", col_names = FALSE) %>% as.matrix()

marshmongoose_dh <-read_csv("data-publication/marsh_mongoose.csv", col_names = FALSE) %>% as.matrix()

#put all data frames together and name them
y <- list(genet_dh, civet_dh, honeybadger_dh, marshmongoose_dh)
names(y) <- c('genet','civet','honey_badger', 'marsh_mongoose')

#load occupancy covariates
occ_covs <- read_csv("data-publication/GNP_covariates_with_pan.csv", col_names = TRUE) %>% as.data.frame()

#scaling all the non-binary, unscaled covariates
occ_covs$tree_hansen = scale(occ_covs$tree_hansen)
occ_covs$cover.ground = scale(occ_covs$cover.ground)
occ_covs$water_dist = scale(occ_covs$water_dist)
occ_covs$termites_1km_count = scale(occ_covs$termites_1km_count)

#copy occ covs to prep det covs
det_covs_23 <- occ_covs

#in 2020, there was a bug in the unmarked package that didn't allow detection covariates into siteCovs
#this repeats each site-level detection covariate for every sample day, needed for predict function
#July 2023 update: unsure if this has been fixed
det_covs_23 <- det_covs_23[rep(seq_len(nrow(det_covs_23)), each = 122), ]

#generate data for use with predict function (separate only because of 2020 bug)
data_predict_23 <- unmarkedFrameOccuMulti(y = y, siteCovs = occ_covs, obsCovs = det_covs_23)

data_predict_23

#generate data
data <- unmarkedFrameOccuMulti(y = y, siteCovs = occ_covs)

#look at data
summary(data)
plot(data)

# Look at f parameter design matrix
data@fDesign
data@ylist
```

my f equation order: 
f1: genet
f2: civet
f3: honey badger
f4: marsh mongoose
f5: genet: civet
f6: genet: honey badger
f7: genet: marsh mongoose
f8: civet: honey badger
f9: civet: marsh mongoose
f10: honey badger: marsh mongoose

#type 1 models, no species interactions
```{r}
#null occupancy formulas (used for all models)
occFormulas_23 <- c('~1', '~1', '~1', '~1', '0','0','0','0','0','0', '0', '0', '0', '0', '0')

#null model for both occupancy and detection
fit0 <- occuMulti(detformulas = c('~1', '~1', '~1', '~1'), stateformulas = occFormulas_23, data)

fit0

#order: genet, civet, hb, mm
detFormulas6_23 <- c('~detect.obscured + cover.ground + tree_hansen', '~detect.obscured + cover.ground + water_dist + termites_1km_count + lion_latedry', '~detect.obscured + cover.ground + termites_1km_count', '~detect.obscured + cover.ground + water_dist')

fit6_23 <- occuMulti(detFormulas6_23, stateformulas = occFormulas_23, data)

fit6_23

#run with predict again in 2023 for best model (incl lion)
fit6_23_predict <- occuMulti(detFormulas6_23, stateformulas = occFormulas_23, data_predict_23)

fit6_23_predict

```

#type 2 models, no interaction covariates]
```{r}
#null model
fit01 <- occuMulti(detformulas = c('~1', '~1', '~1', '~1'), stateformulas = c('~1', '~1', '~1', '~1','~1','~1','~1','~1','~1','~1','0','0','0','0','0'), data)

fit01

#type 2, null occupancy plus informative detection covariates
occFormulas13_23 <- c('~1', '~1', '~1', '~1', '~1','~1','~1','~1','~1','~1', '0', '0', '0', '0', '0')

fit15_23 <- occuMulti(detFormulas6_23, stateformulas = occFormulas13_23, data)

fit15_23
```

#type 3 models, includes interaction covariates
```{r}
#running in 2023 with null occupancy and considering lion as detection

#lion only for genet:civet
occFormulas37_23 <- c('~1','~1','~1','~1','~lion_latedry','~1','~1','~1','~1','~1', '0', '0', '0', '0', '0')

fit50_23 <- occuMulti(detFormulas6_23, stateformulas = occFormulas37_23, data)

fit50_23

#lion only for genet:hb
occFormulas38_23 <- c('~1','~1','~1','~1','~1','~lion_latedry','~1','~1','~1','~1', '0', '0', '0', '0', '0')

fit51_23 <- occuMulti(detFormulas6_23, stateformulas = occFormulas38_23, data)

fit51_23

#lion only for genet:mm
occFormulas39_23 <- c('~1','~1','~1','~1','~1','~1','~lion_latedry','~1','~1','~1', '0', '0', '0', '0', '0')

fit52_23 <- occuMulti(detFormulas6_23, stateformulas = occFormulas39_23, data)

fit52_23

#lion only for civet: hb
occFormulas40_23 <- c('~1','~1','~1','~1','~1','~1','~1','~lion_latedry','~1','~1', '0', '0', '0', '0', '0')

fit53_23 <- occuMulti(detFormulas6_23, stateformulas = occFormulas40_23, data)

fit53_23

#lion only for civet:mm
occFormulas41_23 <- c('~1','~1','~1','~1','~1','~1','~1','~1','~lion_latedry','~1', '0', '0', '0', '0', '0')

fit54_23 <- occuMulti(detFormulas6_23, stateformulas = occFormulas41_23, data)

fit54_23

#lion only for hb:mm
occFormulas42_23 <- c('~1','~1','~1','~1','~1','~1','~1','~1','~1','~lion_latedry', '0', '0', '0', '0', '0')

fit55_23 <- occuMulti(detFormulas6_23, stateformulas = occFormulas42_23, data)

fit55_23
```

#Graph marginal detection probabilities relative to covariates
```{r}
# MAKE DUMMY DATA

#distance to water
water_dist_scalelist <- list(scale = attr(occ_covs$water_dist, "scaled:scale"),
                      center = attr(occ_covs$water_dist, "scaled:center"))
dummy_water <- data.frame(water_dist = seq(min(occ_covs$water_dist, na.rm=T), max(occ_covs$water_dist, na.rm=T), by = 0.0001)) %>%
  mutate(termites_1km_count = 0,
         tree_hansen = 0,
         detect.obscured = 0,
         cover.ground = 0,
         water_unscaled = (water_dist * water_dist_scalelist$scale + water_dist_scalelist$center)/1000)

#lion presence
lion_scalelist <- list(scale = attr(occ_covs$lion_latedry, "scaled:scale"),
                      center = attr(occ_covs$lion_latedry, "scaled:center"))
dummy_lion <- data.frame(lion_latedry = seq(min(occ_covs$lion_latedry, na.rm=T), max(occ_covs$lion_latedry, na.rm=T), by = 0.0001)) %>%
  mutate(termites_1km_count = 0,
         tree_hansen = 0,
         detect.obscured = 0,
         cover.ground = 0,
         water_dist = 0,
         lion_unscaled = (lion_latedry * lion_scalelist$scale + lion_scalelist$center))

#tree_hansen (2023)
tree_hansen_scalelist_23 <- list(scale = attr(occ_covs$tree_hansen, "scaled:scale"), center = attr(occ_covs$tree_hansen, "scaled:center"))
dummy_tree_23 <- data.frame(tree_hansen = seq(min(occ_covs$tree_hansen, na.rm=T), max(occ_covs$tree_hansen, na.rm=T), by = 0.0001)) %>%
  mutate(termites_1km_count = 0,
         water_dist = 0,
         detect.obscured = 0,
         cover.ground = 0,
         tree_unscaled_23 = (tree_hansen * tree_hansen_scalelist_23$scale + tree_hansen_scalelist_23$center))

#termite mound (2023)
termite_scalelist_23 <- list(scale = attr(occ_covs$termites_1km_count, "scaled:scale"),center = attr(occ_covs$termites_1km_count, "scaled:center"))
dummy_termite_23 <- data.frame(termites_1km_count = seq(min(occ_covs$termites_1km_count, na.rm=T), max(occ_covs$termites_1km_count, na.rm=T), by = 0.0001)) %>%
  mutate(tree_hansen = 0,
         water_dist = 0,
         detect.obscured = 0,
         cover.ground = 0,
         termite_unscaled_23 = (termites_1km_count * termite_scalelist_23$scale + termite_scalelist_23$center))

#colorblind colors
#genet:#d55e00
#civet: #0072b2
#hb:#f0e442
#mm:#009e73

#2023 figures needed: genet-tree, civet-lion, civet-water, civet-termite, hb-termite, mm-water

# CIVET & WATER
civet_water_predict <- predict(fit5_23_predict, type = 'det', newdata = dummy_water, species="civet")
civet_water_predict <- cbind(civet_water_predict, dummy_water)
civet_water <- ggplot(data = civet_water_predict, aes(x = water_unscaled, y = Predicted)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), fill = "#0072b2", alpha = 0.25) +
    geom_line(colour = "#0072b2", linewidth = 1) +
    ylim(0,0.2) +
    theme_bw() +
    labs(x = "Distance to Water (km)", y = "Detection Probability") +
    ggtitle(" ")
civet_water

# CIVET & LION
civet_lion_predict <- predict(fit6_23_predict, type = 'det', newdata = dummy_lion, species="civet")
civet_lion_predict <- cbind(civet_lion_predict, dummy_lion)
civet_lion <- ggplot(data = civet_lion_predict, aes(x = lion_unscaled, y = Predicted)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), fill = "#0072b2", alpha = 0.25) +
    geom_line(colour = "#0072b2", linewidth = 1) +
    ylim(0,0.2) +
    theme_bw() +
    labs(x = "Lion Presence", y = "Detection Probability") +
    ggtitle("Civet")
civet_lion

# CIVET & TERMITE
civet_termite_predict <- predict(fit5_23_predict, type = 'det', newdata = dummy_termite_23, species="civet")
civet_termite_predict <- cbind(civet_termite_predict, dummy_termite_23)
civet_termite <- ggplot(data = civet_termite_predict, aes(x = termite_unscaled_23, y = Predicted)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), fill = "#0072b2", alpha = 0.25) +
    geom_line(colour = "#0072b2", linewidth = 1) +
    ylim(0,0.2) +
    theme_bw() +
    labs(x = "Termite Mounds Within 1km" , y = "Detection Probability") +
    ggtitle(" ")
civet_termite

#GENET & TREE (2023)
genet_tree_predict <- predict(fit5_23_predict, type = 'det', newdata = dummy_tree_23, species= 'genet')
genet_tree_predict <- cbind(genet_tree_predict, dummy_tree_23)
genet_tree <- ggplot(data = genet_tree_predict, aes(x = tree_unscaled_23, y = Predicted)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), fill = "#d55e00", alpha = 0.25) +
    geom_line(colour = "#d55e00", linewidth = 1) +
    ylim(0,0.25) +
    theme_bw() +
    labs(x = "Tree Cover (%)", y = "Detection Probability") +
    ggtitle("Genet")
genet_tree

# HONEY BADGER & TERMITE (2023)
honey_badger_termite_predict <- predict(fit5_23_predict, type = 'det', newdata = dummy_termite_23, species="honey_badger")
honey_badger_termite_predict <- cbind(honey_badger_termite_predict, dummy_termite_23)
honey_badger_termite <- ggplot(data = honey_badger_termite_predict, aes(x = termite_unscaled_23, y = Predicted)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), fill = "#f0e442", alpha = 0.25) +
    geom_line(colour = "#f0e442", linewidth = 1) +
    ylim(0,0.1) +
    theme_bw()+
    labs(x = "Termite Mounds Within 1km", y = "Detection Probability") +
    ggtitle("Honey Badger")
honey_badger_termite

# MARSH MONGOOSE & WATER
marsh_mongoose_water_predict <- predict(fit5_23_predict, type = 'det', newdata = dummy_water, species="marsh_mongoose")
#do not run next line more than once! messes with x axis
marsh_mongoose_water_predict <- cbind(marsh_mongoose_water_predict, dummy_water)
marsh_mongoose_water <- ggplot(data = marsh_mongoose_water_predict, aes(x = water_unscaled, y = Predicted)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), fill = "#009e73", alpha = 0.25) +
    geom_line(colour = "#009e73", linewidth = 1) +
    ylim(0,0.1) +
    theme_bw() +
    labs( x = "Distance to Water (km)", y = "Detection Probability") +
    ggtitle("Marsh Mongoose")
marsh_mongoose_water

#2023 create and save figure with all components
pdf("scripts/figures/best_interaction_model_predict_23.pdf", width = 8, height = 5)
ggarrange(civet_lion, civet_termite, civet_water, genet_tree, honey_badger_termite, marsh_mongoose_water, ncol = 3, nrow = 2)
dev.off()
```